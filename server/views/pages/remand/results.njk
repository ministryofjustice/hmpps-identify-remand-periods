{% from "govuk/components/error-summary/macro.njk" import govukErrorSummary %}
{% from "govuk/components/textarea/macro.njk" import govukTextarea %}
{% from "govuk/components/radios/macro.njk" import govukRadios %}
{% from "govuk/components/table/macro.njk" import govukTable %}
{% from "govuk/components/details/macro.njk" import govukDetails %}
{% from "govuk/components/warning-text/macro.njk" import govukWarningText %}
{% from "govuk/components/inset-text/macro.njk" import govukInsetText %}
{% from "../../macros/remandRow.njk" import remandRow %}

{% extends "../../partials/layout.njk" %}

{% set pageTitle = applicationName + " - Home" %}
{% set mainClasses = "app-container govuk-body" %}

{% block content %}

    {% if form.errors.length %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: form.errorList()
        }) }}
            </div>
        </div>
    {% elif model
            .allErrors()
            .length %}
        {% set unrelatedHtml %}
        <ul class="govuk-list govuk-error-summary__list">
            {% for error in model.otherErrors() %}
                <li>{{error.message}}
                    {% if model.includeBookNumberInMessage(error)%}within booking {{error.bookNumber}}
                    {% endif %}
                </li>
            {% endfor %}
        </ul>
        {% endset -%}

        {% set errorHtml %}
        {% if model
            .mostImportantErrors()
            .length %}
        These errors relate to offences that have relevant remand.
        <ul class="govuk-list govuk-error-summary__list">
                {% for error in model
            .mostImportantErrors()%}
                    <li>{{error.message}}
                        {% if model.includeBookNumberInMessage(error)%}within booking {{error.bookNumber}}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>

            {% if model
                .otherErrors()
                .length %}
                {{ govukDetails({
        summaryText: "There are more errors with nomis data that is unrelated to the given relevant remand",
        html: unrelatedHtml,
        classes: "govuk-!-margin-top-6"
        }) }}
            {% endif %}

        {% elif model
                .otherErrors()
                .length %}
                 There are errors with nomis data that is unrelated to the given relevant remand.
        <ul class="govuk-list govuk-error-summary__list">
                {% for error in model
            .otherErrors()%}
                    <li>{{error.message}}
                        {% if model.includeBookNumberInMessage(error)%}within booking {{error.bookNumber}}
                        {% endif %}
                    </li>
                {% endfor %}
            </ul>
        {% endif %}

        {% endset -%}

        {{ govukErrorSummary({
          titleText: "There is a problem",
          errorList: [],
          descriptionHtml: errorHtml
    }) }}
    {% endif %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

            <h1 class="govuk-heading-l">
                <span class="govuk-caption-xl">Adjustments</span>Check remand details for {{model.prisonerDetail.firstName | title}}
                {{model.prisonerDetail.lastName | title}}</h1>

            <p class="govuk-!-margin-bottom-8">Based on the court case information in NOMIS, the following remand has been counted as relevant remand.

                    The rules for applying remand time can be found in the <a href="https://assets.publishing.service.gov.uk/government/uploads/system/uploads/attachment_data/file/1083190/sc-annex-a-operational-guidance.pdf#page=72">policy framework</a>.</p>

            {{ govukWarningText({
                text: "Remand time served alongside a custodiale sentence cannot be counted. A period of relevant remand can only be counted once.",
                iconFallbackText: "Warning"
                }) }}

        </div>
    </div>

    {% if model.relevantRemand.sentenceRemand.length %}
        <div class="govuk-grid-row">
            <div class="govuk-grid-column-full">
                <article class="moj-ticket-panel govuk-!-margin-bottom-8" aria-label="Sub navigation 1">

                    <section class="moj-ticket-panel__content moj-ticket-panel__content--blue" aria-label="Section 1">
                        <table class="govuk-table">
                            <caption class="govuk-table__caption govuk-table__caption--m">Remand identified</caption>
                            <thead class="govuk-table__head">
                                <tr class="govuk-table__row">
                                    <th scope="col" class="govuk-table__header">From</th>
                                    <th scope="col" class="govuk-table__header">To</th>
                                    <th scope="col" class="govuk-table__header">Days</th>
                                    <th scope="col" class="govuk-table__header">Offences included in this period</th>
                                </tr>
                            </thead>
                            <tbody class="govuk-table__body">
                                {% for remand in model.relevantRemand.sentenceRemand %}
                                    <tr class="govuk-table__row">
                                        <td class="govuk-table__cell">{{remand.from | date('DD MMMM YYYY') }}</td>
                                        <td class="govuk-table__cell">{{remand.to | date('DD MMMM YYYY') }}</td>
                                        <td class="govuk-table__cell">{{remand.days}}</td>
                                        <td class="govuk-table__cell">
                                            {% for charge in model.sharedRemand(remand) %}
                                                {{charge.offence.description}}<br/>
                                                {% if (charge.offenceDate and charge.offenceEndDate and charge.offenceEndDate !== charge.offenceDate) %}
                        committed from {{ charge.offenceDate | date('DD MMMM YYYY') }} to {{ charge.offenceEndDate | date('DD MMMM YYYY') }}
                                                {% elif charge.offenceDate %}
                        committed on {{ charge.offenceDate | date('DD MMMM YYYY') }}
                                                {% endif %}
                                                <br/><br/>
                                            {% endfor %}
                                        </td>
                                    </tr>
                                {% endfor %}
                            </tbody>
                        </table>

                    </section>

                </article>

                {{ govukInsetText({
              text: "Please note that they may not have been remanded for the whole period for every offence; see the deatils section below."
            }) }}

            </div>
        </div>
    {% else %}
        <p class="govuk-body">No remand identified.</p>
    {% endif %}
    <div class="govuk-grid-row">
        <div class="govuk-grid-column-two-thirds">

            {% if model.relevantChargeRemand.length or model.notRelevantChargeRemand.length %}
                <h2 class="govuk-heading-m">Details</h2>
                {% if model.relevantChargeRemand.length %}
                    <h3 class="govuk-heading-s">Relevant remand periods</h2>
                    <table class="govuk-table govuk-!-margin-bottom-8">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row">
                                <th class="govuk-table__header" scope="col">Remand periods identified from court cases</th>
                                <th class="govuk-table__header govuk-!-text-align-centre" scope="col">Days</th>
                            </tr>
                        </thead>
                        <tbody class="govuk-table__body">
                            {% for remand in model.relevantChargeRemand %}
                                {{ remandRow(remand, model, true)}}
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}
                {% if model.notRelevantChargeRemand.length %}
                    <h3 class="govuk-heading-s">Non-relevant remand periods</h2>
                    <table class="govuk-table govuk-!-margin-bottom-8">
                        <thead class="govuk-table__head">
                            <tr class="govuk-table__row">
                                <th class="govuk-table__header" scope="col">Remand periods identified from court cases</th>
                                <th class="govuk-table__header govuk-!-text-align-centre" scope="col">Days</th>
                            </tr>
                        </thead>
                        <tbody class="govuk-table__body">
                            {% for remand in model.notRelevantChargeRemand %}
                                {{ remandRow(remand, model, false)}}
                            {% endfor %}
                        </tbody>
                    </table>
                {% endif %}

            {% endif %}
            {% if model.relevantRemand.intersectingSentences.length %}
                <div class="govuk-grid-row">
                    <div class="govuk-grid-column-full">
                        {{ govukTable( model.intersectingSentenceTable() )}}
                    </div>
                </div>
            {% endif %}

            {% if model
                .mostImportantErrors()
                .length == 0 %}
                <form class="form" method="post">
                    <input type="hidden" name="_csrf" value="{{ csrfToken }}"/>

                    {% set commentHtml %}
                    {{ govukTextarea({
                    name: "comment",
                    id: "comment",
                    value: form.comment,
                    label: {
                        text: "Why is this remand calculation incorrect?",
                        classes: "govuk-fieldset__legend--l"
                    },
                    hint: {
                        text: "Include any information that may be relevant to your decision."
                    },
                    errorMessage: form.messageForField('comment')
                    }) }}
                    {% endset -%}

                    {{ govukRadios({
                name: "decision",
                fieldset: {
                    legend: {
                    text: "Is this remand correct?",
                    classes: "govuk-fieldset__legend--l"
                    }
                },
                hint: {
                    text: "By selecting Yes, you are confirming that, to the best of your knowledge, the information is correct. The remand identified will be saved in NOMIS."
                },
                errorMessage: form.messageForField('decision'),
                value: form.decision,
                items: [
                    {
                        value: "yes",
                        text: "Yes"
                    },
                    {
                        value: "no",
                        text: "No",
                        conditional: {
                            html: commentHtml
                        }
                    }
                ]
                }) }}
                    <div>
                        <button class="govuk-button" data-module="govuk-button" name="submit">Confirm</button>
                    </div>
                </form>
            {% endif %}
            <a href="{{model.returnToAdjustments()}}" class="govuk-link">Cancel and return to adjustments</a>
        </div>
    </div>
{% endblock %}